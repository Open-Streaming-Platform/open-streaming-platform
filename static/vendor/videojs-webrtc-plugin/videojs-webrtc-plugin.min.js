/*! @name @antmedia/videojs-webrtc-plugin @version 2.0.0 @license MIT */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t(require("video.js")):"function"==typeof define&&define.amd?define(["video.js"],t):(e="undefined"!=typeof globalThis?globalThis:e||self).videojsWebrtcPlugin=t(e.videojs)}(this,(function(e){"use strict";function t(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var n=t(e),o="takeCandidate",i="takeConfiguration",r="play",a="stop",s="getStreamInfo",c="peerMessageCommand",d="forceStreamQuality",l="error",u="notification",p="streamInformation",h="ping",f="pong",m="trackList",C=function(){function e(e){for(var t in e)e.hasOwnProperty(t)&&(this[t]=e[t]);this.initWebSocketConnection()}var t=e.prototype;return t.initWebSocketConnection=function(e){var t=this;this.connecting=!0,this.connected=!1,this.pingTimerId=-1,this.wsConn=new WebSocket(this.websocketUrl),this.wsConn.onopen=function(){t.pingTimerId=setInterval((function(){t.sendPing()}),3e3),t.connected=!0,t.connecting=!1,t.callback("initialized"),void 0!==e&&e()},this.wsConn.onmessage=function(e){var n=JSON.parse(e.data);switch(n.command){case o:t.webrtcadaptor.takeCandidate(n.streamId,n.label,n.candidate);break;case i:t.webrtcadaptor.takeConfiguration(n.streamId,n.sdp,n.type,n.idMapping);break;case a:t.webrtcadaptor.closePeerConnection(n.streamId);break;case l:t.callbackError(n.definition);break;case u:t.callback(n.definition,n),"play_finished"!==n.definition&&"publish_finished"!==n.definition||t.webrtcadaptor.closePeerConnection(n.streamId);break;case p:t.callback(n.command,n);break;case f:t.callback(n.command);break;case m:case c:t.callback(n.command,n)}},this.wsConn.onerror=function(e){t.connecting=!1,t.connected=!1,t.clearPingTimer(),t.callbackError("WebSocketNotConnected",e)},this.wsConn.onclose=function(e){t.connecting=!1,t.connected=!1,t.clearPingTimer(),t.callback("closed",e)}},t.clearPingTimer=function(){-1!==this.pingTimerId&&(clearInterval(this.pingTimerId),this.pingTimerId=-1)},t.sendPing=function(){var e={command:h};this.wsConn.send(JSON.stringify(e))},t.close=function(){this.wsConn.close()},t.send=function(e){var t=this;this.connecting||this.connected?this.wsConn.send(e):this.initWebSocketConnection((function(){t.send(e)}))},t.isConnected=function(){return this.connected},t.isConnecting=function(){return this.connecting},e}(),b=function(){function e(e){for(var t in this.pcConfig=null,this.websocketUrl=null,this.sdpConstraints=null,this.remotePeerConnection=[],this.remoteDescriptionSet=[],this.iceCandidateList=[],this.playStreamId=[],this.player=null,this.webSocketAdaptor=null,this.viewerInfo="",this.idMapping=[],this.candidateTypes=["udp","tcp"],e)e.hasOwnProperty(t)&&(this[t]=e[t]);this.remoteVideo=this.player,this.checkWebSocketConnection()}var t=e.prototype;return t.play=function(e,t,n,o){this.playStreamId.push(e);var i={command:r,streamId:e,token:t,subscriberId:n||"",subscriberCode:o||"",viewerInfo:this.viewerInfo};this.webSocketAdaptor.send(JSON.stringify(i))},t.stop=function(e){this.closePeerConnection(e);var t={command:a,streamId:e};this.webSocketAdaptor.send(JSON.stringify(t))},t.getStreamInfo=function(e){var t={command:s,streamId:e};this.webSocketAdaptor.send(JSON.stringify(t))},t.onTrack=function(e,t){if(this.remoteVideo){var n=this.remoteVideo.tech().el();n.srcObject!==e.streams[0]&&(n.srcObject=e.streams[0])}},t.iceCandidateReceived=function(e,t){if(e.candidate){var n=!1;if(""===e.candidate.candidate?n=!0:void 0===e.candidate.protocol?this.candidateTypes.forEach((function(t){e.candidate.candidate.toLowerCase().includes(t)&&(n=!0)})):n=this.candidateTypes.includes(e.candidate.protocol.toLowerCase()),n){var i={command:o,streamId:t,label:e.candidate.sdpMLineIndex,id:e.candidate.sdpMid,candidate:e.candidate.candidate};this.webSocketAdaptor.send(JSON.stringify(i))}else""!==e.candidate.candidate&&this.callbackError("protocol_not_supported","Support protocols: "+this.candidateTypes.toString()+" candidate: "+e.candidate.candidate)}},t.initPeerConnection=function(e){var t=this;if(!this.remotePeerConnection[e]){var n=e;this.remotePeerConnection[e]=new RTCPeerConnection(this.pcConfig),this.remoteDescriptionSet[e]=!1,this.iceCandidateList[e]=[],this.remotePeerConnection[e].onicecandidate=function(e){t.iceCandidateReceived(e,n)},this.remotePeerConnection[e].ontrack=function(e){t.onTrack(e,n)},this.remotePeerConnection[e].oniceconnectionstatechange=function(){var n={state:t.remotePeerConnection[e].iceConnectionState,streamId:e};t.callback("ice_connection_state_changed",n)}}},t.closePeerConnection=function(e){this.remotePeerConnection[e]&&"closed"!==this.remotePeerConnection[e].signalingState&&(this.remotePeerConnection[e].close(),this.remotePeerConnection[e]=null,delete this.remotePeerConnection[e],this.playStreamId=this.playStreamId.filter((function(t){return t!==e})))},t.gotDescription=function(e,t){var n=this;this.remotePeerConnection[t].setLocalDescription(e).then((function(){var o={command:i,streamId:t,type:e.type,sdp:e.sdp};n.webSocketAdaptor.send(JSON.stringify(o))}))},t.takeConfiguration=function(e,t,n,o){var i=this,r=e;this.idMapping[r]=o,this.initPeerConnection(r),this.remotePeerConnection[r].setRemoteDescription({sdp:t,type:n}).then((function(){i.remoteDescriptionSet[r]=!0;for(var e=i.iceCandidateList[r].length,t=0;t<e;t++)i.addIceCandidate(r,i.iceCandidateList[r][t]);i.iceCandidateList[r]=[],"offer"===n&&i.remotePeerConnection[r].createAnswer(i.sdpConstraints).then((function(e){e.sdp=e.sdp.replace("useinbandfec=1","useinbandfec=1; stereo=1"),i.gotDescription(e,r)}))})).catch((function(e){(e.toString().includes("InvalidAccessError")||e.toString().includes("setRemoteDescription"))&&i.callbackError("notSetRemoteDescription")}))},t.takeCandidate=function(e,t,n){var o=e,i=new RTCIceCandidate({sdpMLineIndex:t,candidate:n});this.initPeerConnection(o),!0===this.remoteDescriptionSet[o]?this.addIceCandidate(o,i):this.iceCandidateList[o].push(i)},t.addIceCandidate=function(e,t){var n=!1;""===t.candidate?n=!0:void 0===t.protocol?this.candidateTypes.forEach((function(e){t.candidate.toLowerCase().includes(e)&&(n=!0)})):n=this.candidateTypes.includes(t.protocol.toLowerCase()),n&&this.remotePeerConnection[e].addIceCandidate(t)},t.closeWebSocket=function(){for(var e in this.remotePeerConnection)this.remotePeerConnection[e].close();this.remotePeerConnection=[],this.webSocketAdaptor.close()},t.checkWebSocketConnection=function(){var e=this.webSocketAdaptor,t=e&&this.webSocketAdaptor.isConnected()&&this.webSocketAdaptor.isConnecting();if(!e||!t)try{this.webSocketAdaptor=new C({websocketUrl:this.websocketUrl,webrtcadaptor:this,callback:this.callback,callbackError:this.callbackError})}catch(e){this.player.createModal("WebSocket connect error")}},t.peerMessage=function(e,t,n){var o={command:c,streamId:e,definition:t,data:n};this.webSocketAdaptor.send(JSON.stringify(o))},t.forceStreamQuality=function(e,t){var n={command:d,streamId:e,streamHeight:t};this.webSocketAdaptor.send(JSON.stringify(n))},e}(),g="initialized",y="play_started",v="play_finished",k="streamInformation",S="resolutionChangeInfo";function w(e,t,n){return e(n={path:t,exports:{},require:function(e,t){return function(){throw new Error("Dynamic requires are not currently supported by @rollup/plugin-commonjs")}(null==t&&n.path)}},n.exports),n.exports}var I=w((function(e){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e},e.exports.default=e.exports,e.exports.__esModule=!0})),P=w((function(e){function t(n,o){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},e.exports.default=e.exports,e.exports.__esModule=!0,t(n,o)}e.exports=t,e.exports.default=e.exports,e.exports.__esModule=!0})),R=w((function(e){e.exports=function(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,P(e,t)},e.exports.default=e.exports,e.exports.__esModule=!0})),T=n.default.getComponent("MenuItem"),M=n.default.getComponent("Component"),O=function(e){function t(t,n){return n.selectable=!0,n.multiSelectable=!1,e.call(this,t,n)||this}return R(t,e),t.prototype.handleClick=function(){this.options().plugin.changeStreamQuality(this.options().value)},t}(T);M.registerComponent("ResolutionMenuItem",O);var j=n.default.getComponent("MenuButton"),N=function(e){function t(t,n){var o;return o=e.call(this,t,n)||this,j.apply(I(o),arguments),o}R(t,e);var o=t.prototype;return o.createEl=function(){return n.default.dom.createEl("div",{className:"vjs-http-source-selector vjs-menu-button vjs-menu-button-popup vjs-control vjs-button"})},o.buildCSSClass=function(){return j.prototype.buildCSSClass.call(this)+" vjs-icon-cog"},o.update=function(){return j.prototype.update.call(this)},o.createItems=function(){for(var e=[],t=[{label:"auto",value:0}].concat(this.player().resolutions),n=0;n<t.length;n++)e.push(new O(this.player_,{label:t[n].label,value:t[n].value,selected:t[n].value===this.player().selectedResolution,plugin:this.options().plugin,streamName:this.options().streamName}));return e},t}(j),x={sdpConstraints:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0},mediaConstraints:{video:!1,audio:!1}},A=function(){function e(e,t,o){var i=this;this.player=n.default(o.playerId),this.initiateWebRTCAdaptor(e,o),this.player.ready((function(){i.player.addClass("videojs-webrtc-plugin")})),this.player.on("playing",(function(){i.player.el().getElementsByClassName("vjs-custom-spinner").length&&i.player.el().removeChild(i.player.spinner)})),n.default.registerComponent("ResolutionMenuButton",N),n.default.registerComponent("ResolutionMenuItem",O)}var t=e.prototype;return t.initiateWebRTCAdaptor=function(e,t){var o=this;this.options=n.default.mergeOptions(x,t),this.source=e,this.source.pcConfig={iceServers:JSON.parse(e.iceservers)},this.source.mediaServerUrl=e.src.split("/").slice(0,4).join("/")+"/websocket",this.source.streamName=e.src.split("/")[4].split(".webrtc")[0],this.source.token=this.getUrlParameter("token"),this.source.subscriberId=this.getUrlParameter("subscriberId"),this.source.subscriberCode=this.getUrlParameter("subscriberCode"),this.webRTCAdaptor=new b({websocketUrl:this.source.mediaServerUrl,mediaConstraints:this.source.mediaConstraints,pcConfig:this.source.pcConfig,sdpConstraints:this.source.sdpConstraints,player:this.player,callback:function(e,t){switch(e){case g:o.initializedHandler();break;case y:o.joinStreamHandler(t);break;case v:o.leaveStreamHandler(t);break;case k:o.streamInformationHandler(t);break;case S:o.resolutionChangeHandler(t);break;default:o.defaultHandler(e)}},callbackError:function(e){var t=n.default.getComponent("ModalDialog");o.errorModal&&o.errorModal.close(),o.errorModal=new t(o.player,{content:"ERROR: "+JSON.stringify(e),temporary:!0,pauseOnOpen:!1,uncloseable:!0}),o.player.addChild(o.errorModal),o.errorModal.open(),o.errorModal.setTimeout((function(){return o.errorModal.close()}),3e3),o.player.trigger("webrtc-error",{error:e})}})},t.initializedHandler=function(){this.webRTCAdaptor.play(this.source.streamName,this.source.token,this.source.subscriberId,this.source.subscriberCode)},t.joinStreamHandler=function(e){this.webRTCAdaptor.getStreamInfo(this.source.streamName)},t.leaveStreamHandler=function(){this.player.resolutions=[],this.player.controlBar.getChild("ResolutionMenuButton").update()},t.streamInformationHandler=function(e){var t=e.streamInfo.reduce((function(e,t){return e.includes(t.streamHeight)?e:[].concat(e,[t.streamHeight])}),[]).sort((function(e,t){return t-e}));this.player.resolutions=t.map((function(e){return{label:e,value:e}})),this.player.selectedResolution=0,this.addResolutionButton()},t.addResolutionButton=function(){var e=this.player.controlBar,t=e.getChild("fullscreenToggle").el();e.getChild("ResolutionMenuButton")&&e.removeChild("ResolutionMenuButton"),e.el().insertBefore(e.addChild("ResolutionMenuButton",{plugin:this,streamName:this.source.streamName}).el(),t)},t.resolutionChangeHandler=function(e){var t=this;this.player.spinner=document.createElement("div"),this.player.spinner.className="vjs-custom-spinner",this.player.el().appendChild(this.player.spinner),this.player.pause(),this.player.setTimeout((function(){t.player.el().getElementsByClassName("vjs-custom-spinner").length&&(t.player.el().removeChild(t.player.spinner),t.player.play())}),2e3)},t.defaultHandler=function(e){},t.changeStreamQuality=function(e){this.webRTCAdaptor.forceStreamQuality(this.source.streamName,e),this.player.selectedResolution=e,this.player.controlBar.getChild("ResolutionMenuButton").update()},t.getUrlParameter=function(e){return this.source.src.includes("?")?(this.source.src.split("?")[1].split("&").reduce((function(e,t){var n=t.split("=");return e[decodeURIComponent(n[0])]=decodeURIComponent(n[1]),e}),{})||{})[e]:null},e}(),_={name:"videojs-webrtc-plugin",VERSION:"1.1",canHandleSource:function(e,t){void 0===t&&(t={});var o=n.default.mergeOptions(n.default.options,t);return o.source=e.src,_.canPlayType(e.type,o)},handleSource:function(e,t,o){void 0===o&&(o={});var i=n.default.mergeOptions(n.default.options,o);return t.webrtc=new A(e,t,i),t.webrtc},canPlayType:function(e,t){return void 0===t&&(t={}),t.source.split("/")[4].includes(".webrtc")?"maybe":""}};return n.default.getTech("Html5").registerSourceHandler(_,0),{WebRTCHandler:A,webRTCSourceHandler:_}}));
